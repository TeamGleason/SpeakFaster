import {Component, HostListener} from '@angular/core';

import {HttpEventLogger} from '../event-logger/event-logger-impl';
import {getVirtualkeyCode} from '../external/external-events.component';

// The return value indicates whether the event has been handled.
export type KeyboardCallback = (event: KeyboardEvent) => boolean;

@Component({
  selector: 'app-keyboard-component',
  templateUrl: './keyboard.component.html',
})
export class KeyboardComponent {
  private static readonly _NAME = 'KeyboardComponent';

  constructor(private eventLogger: HttpEventLogger) {}

  @HostListener('document:keydown', ['$event'])
  onKeydown(event: KeyboardEvent) {
    // https://stackoverflow.com/a/45436329
    // console.log('*** keydown: event.key:', event.key);  // DEBUG
    // const currentCode = event.which || event.code;
    // console.log('*** keydown: event currentCode:', currentCode);  // DEBUG
    // this.eventLogger.logKeypress(event);
    if ((window as any).externalKeypressHook !== undefined) {
      try {
        const vkCodes = getVirtualkeyCode(event.key);
        // NOTE: While most event.key values are traslated into a single
        // virtual-key code, some special keys (e.g., '!' and '?') are
        // translated into multiple key codes (e.g., shift + 1 and shift + /).
        // We take the last key code in the sequence in such cases, in order to
        // ensure correct reconstruction of the text from keypresses.
        const vkCode: number = vkCodes[vkCodes.length - 1];
        // event.preventDefault();  // TODO(cais): Add unit test.
        (window as any).externalKeypressHook(vkCode, /* isExternal= */ false);
      } catch (error) {
      }
    }
  }

}
